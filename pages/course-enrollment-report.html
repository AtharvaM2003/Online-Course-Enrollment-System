<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="#" onclick="loadPage('admin-dashboard.html')">Reports</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">Enrollment Report</li>
    </ol>
</nav>

<h2 class="mb-3">Course Enrollment Report</h2>

<div class="mb-3">
    <input type="text" id="courseSearch" class="form-control form-control mb-3" placeholder="Search by Course Title...">
</div>

<div class="table-responsive">
    <table class="table table-bordered align-middle">
        <thead class="table-light">
            <tr>
                <th>Course ID</th>
                <th>Course Title</th>
                <th>Instructor Name</th>
                <th>Total Enrollments</th>
            </tr>
        </thead>
        <tbody id="courseEnrollBody"></tbody>
    </table>
</div>

<script>
    (() => {
        const apiUrl = "http://localhost:3000";
        const courseUrl = `${apiUrl}/Courses`;
        const instructorUrl = `${apiUrl}/Instructors`;
        const enrollUrl = `${apiUrl}/Enrollments`;

        const tbody = document.getElementById("courseEnrollBody");
        const searchInput = document.getElementById("courseSearch");

        let allCourses = [];
        let instructorList = [];
        let enrollCountMap = {};
        let sortDirection = 1;
        //------------------------------------------------------------------------------

        searchInput.addEventListener("input", () => {
            const query = searchInput.value.toLowerCase();
            const filtered = allCourses.filter(course =>
                course.title.toLowerCase().includes(query)
            );
            renderCourseRows(filtered);
        });
        //---------------------------------------------------------------------------------
        document.querySelector("th:nth-child(2)").style.cursor = "pointer";
        document.querySelector("th:nth-child(2)").addEventListener("click", () => {
            const sorted = [...allCourses].sort((a, b) =>
                a.title.localeCompare(b.title) * sortDirection
            );
            sortDirection *= -1;
            renderCourseRows(sorted);
        });
        document.querySelector("th:nth-child(3)").style.cursor = "pointer";
        document.querySelector("th:nth-child(3)").addEventListener("click", () => {
            const sorted = [...instructorList].sort((a, b) =>
                a.name.localeCompare(b.name) * sortDirection
            );
            sortDirection *= -1;
            renderCourseRows(sorted);
        });


        //---------------------------------------------------------------------------------   
        function renderCourseRows(courses) {
            tbody.innerHTML = "";
            courses.forEach(course => {
                const tr = document.createElement("tr");

                const instructor = instructorList.find(inst => inst.id === course.instructorid);
                const instructorName = instructor ? instructor.name : "N/A";
                const enrollCount = enrollCountMap[course.id] || 0;

                tr.innerHTML = `
                    <td>${course.id}</td>
                    <td>${course.title}</td>
                    <td>${instructorName}</td>
                    <td>${enrollCount}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        async function fetchCourseEnrollmentData() {
            try {
                const [courseRes, enrollRes, instructorRes] = await Promise.all([
                    fetch(courseUrl),
                    fetch(enrollUrl),
                    fetch(instructorUrl)
                ]);

                const [courseData, enrollData, instructorData] = await Promise.all([
                    courseRes.json(),
                    enrollRes.json(),
                    instructorRes.json()
                ]);

                allCourses = courseData;
                instructorList = instructorData;

                enrollCountMap = {};
                enrollData.forEach(enroll => {
                    const cid = enroll.courseid;
                    enrollCountMap[cid] = (enrollCountMap[cid] || 0) + 1;
                });

                renderCourseRows(allCourses);
            } catch (err) {
                console.error("Error while loading data:", err);
            }
        }

        fetchCourseEnrollmentData();
    })();
</script>