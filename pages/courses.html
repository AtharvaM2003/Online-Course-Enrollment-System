<nav aria-label="breadcrumb">
    <ol class="breadcrumb p-3">
        <li class="breadcrumb-item"><a href="#">Student</a></li>
        <li class="breadcrumb-item active" aria-current="page">Enroll Courses</li>
    </ol>
</nav>

<div class="container">
    <h2 class="mb-3">Enroll New Courses</h2>
    <p>Here are all the courses available to enroll.</p>

    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" id="searchBar" class="form-control" placeholder="Search courses">
        </div>
        <div class="col-md-2">
            <select class="form-select" id="priceFilter">
                <option value="default">Sort by Price</option>
                <option value="low">Price: Low to High</option>
                <option value="high">Price: High to Low</option>
            </select>
        </div>
    </div>

    <div class="row" id="courseList"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

    (() => {
        const apiUrl = "http://localhost:8080/api";
        const courseList = document.getElementById('courseList');
        const searchBar = document.getElementById('searchBar');
        const priceFilter = document.getElementById('priceFilter');

        let allInstructors = [];
        let allCourses = [];
        let allEnrollmentIds = [];

        function getUserId() {
            return sessionStorage.getItem("userId");
        }

        function getUserName() {
            return sessionStorage.getItem("userName");
        }

        function fetchData() {
            Promise.all([
                fetch(`${apiUrl}/instructors`).then(res => res.json()),
                fetch(`${apiUrl}/courses`).then(res => res.json()),
                fetch(`${apiUrl}/enrollments?userid=${getUserId()}`).then(res => res.json())
            ])
                .then(([instructorsData, coursesData, enrollmentsData]) => {
                    allInstructors = instructorsData;
                    allCourses = coursesData;
                    allEnrollmentIds = enrollmentsData.map(e => e.courseid);

                    renderCourses(allCourses);
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                });
        }

        //Display Courses in form of card-----------------------------------------------

        function renderCourses(courses) {
            courseList.innerHTML = "";
            courses.forEach(course => {

                const instructor = allInstructors.find(inst => inst.id === course.instructorid);
                let instructorName = instructor ? instructor.name : "N/A";

                //Dynamic Card-------------------------------------
                const card = document.createElement('div');
                card.className = "col-md-4 mb-4 course-card";
                card.setAttribute('data-price', course.fees);
                card.setAttribute('data-name', course.title);
                card.innerHTML = `
                <div class="card shadow-sm h-100" style="cursor: pointer;">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">${course.title}</h5>
                        <p class="card-text">${course.description}</p>
                        <p><strong>Instructor:</strong> ${instructorName}</p>
                        <p><strong>Price:</strong> â‚¹${course.fees}</p>
                        <button class="btn mt-auto ${allEnrollmentIds.includes(course.id) ? 'btn-secondary' : 'btn-primary'}" 
                            ${allEnrollmentIds.includes(course.id) ? 'disabled' : ''}>
                            ${allEnrollmentIds.includes(course.id) ? 'Enrolled' : 'Enroll'}
                        </button>
                    </div>
                </div>
            `;

                const enrollButton = card.querySelector('button');
                if (!allEnrollmentIds.includes(course.id)) {
                    enrollButton.addEventListener('click', function () {
                        enrollInCourse(course.id, enrollButton);
                    });
                }

                courseList.appendChild(card);
            });
        }

        //Enrollment Transaction-------------------------------------------
        function enrollInCourse(courseId, button) {
            if (allEnrollmentIds.includes(courseId)) return;

            const enrollmentData = {
                userid: getUserId(),
                courseid: String(courseId),
                enrollmentdate: new Date().toISOString().split('T')[0]
            };

            fetch(`${apiUrl}/enrollments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(enrollmentData)
            })
                .then(response => {
                    if (response.ok) {
                        allEnrollmentIds.push(courseId);
                        button.classList.remove('btn-primary');
                        button.classList.add('btn-secondary');
                        button.textContent = 'Enrolled';
                        button.disabled = true;
                        alert('Enrollment Successful!');
                    } else {
                        alert('Failed to enroll!');
                    }
                })
                .catch(error => {
                    console.error('Error enrolling:', error);
                    alert('Something went wrong. Please try again.');
                });
        }

        // Searching---------------------------------------------------------
        searchBar.addEventListener('input', () => {
            const query = searchBar.value.toLowerCase();
            document.querySelectorAll('.course-card').forEach(card => {
                const name = card.getAttribute('data-name').toLowerCase();
                card.style.display = name.includes(query) ? 'block' : 'none';
            });
        });

        // Price filter------------------------------------------------------
        priceFilter.addEventListener('change', () => {
            const filter = priceFilter.value;
            let courseCards = [...document.querySelectorAll('.course-card')];

            courseCards.sort((a, b) => {
                const priceA = parseInt(a.getAttribute('data-price'));
                const priceB = parseInt(b.getAttribute('data-price'));
                return filter === 'low' ? priceA - priceB : filter === 'high' ? priceB - priceA : 0;
            });

            courseList.innerHTML = "";
            courseCards.forEach(card => courseList.appendChild(card));
        });

        fetchData();
    })();
    //END----------------------------------------------------------
</script>