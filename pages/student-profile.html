<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="#" onclick="loadPage('student-profile.html')">Menu</a></li>
        <li class="breadcrumb-item active" aria-current="page">Profile</li>
    </ol>
</nav>

<h2>Student Profile</h2>
<p>Here are the details of your profile.</p>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Student Information</h5>

                <p><strong>Name:</strong> <span id="studentName">Loading...</span></p>
                <p><strong>Email:</strong> <span id="studentEmail">Loading...</span></p>
                <p><strong>Phone:</strong> <span id="studentPhone">Loading...</span></p>

                <div class="mt-4">
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#editProfileModal">Edit
                        Profile</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form novalidate>
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPhone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="editPhone" required>
                    </div>
                    <div class="mb-3" style="position: relative;">
                        <label for="editPass" class="form-label" style="position: relative;">Password</label>
                        <input type="password" class="form-control" id="editPass" required>
                        <i id="togglePassword" class="fa-solid fa-eye"
                            style="position: absolute; top: 60%; right: 15px;  cursor: pointer; ">
                        </i>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save Changes</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    (() => {
        const apiUrl = "http://localhost:8080/api";
        const studentNamePara = document.getElementById("studentName");
        const studentEmailPara = document.getElementById("studentEmail");
        const studentPhonePara = document.getElementById("studentPhone");

        const editNameInput = document.getElementById("editName");
        const editPhoneInput = document.getElementById("editPhone");
        const editPassInput = document.getElementById("editPass");

        const form = document.querySelector("form");

        const togglePassword = document.getElementById('togglePassword');

        //Show Password
        togglePassword.addEventListener('click', function () {
            const type = editPassInput.type === 'password' ? 'text' : 'password';
            editPassInput.type = type;

            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        //------------------------------------------------------------------
        function getUserId() {
            return sessionStorage.getItem("userId");
        }

        function loadStudentProfile() {
            fetch(`${apiUrl}/users/${getUserId()}`)
                .then(res => res.json())
                .then(data => {
                    studentNamePara.textContent = data.name;
                    studentEmailPara.textContent = data.email;
                    studentPhonePara.textContent = data.phone;

                    editNameInput.value = data.name;
                    editPhoneInput.value = data.phone;
                    editPassInput.value = data.password;
                });
        }

        function validateUsername() {
            if (editNameInput.value.trim().length >= 5) {
                editNameInput.classList.add("is-valid");
                editNameInput.classList.remove("is-invalid");
                return true;
            } else {
                editNameInput.classList.add("is-invalid");
                editNameInput.classList.remove("is-valid");
                return false;
            }
        }

        function validatePassword() {
            const pass = editPassInput.value;
            const passRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\W).{8,}$/;
            if (passRegex.test(pass)) {
                editPassInput.classList.add("is-valid");
                editPassInput.classList.remove("is-invalid");
                return true;
            } else {
                editPassInput.classList.add("is-invalid");
                editPassInput.classList.remove("is-valid");
                return false;
            }
        }

        function validateMobile() {
            const mobileRegex = /^[789]\d{9}$/;
            if (mobileRegex.test(editPhoneInput.value.trim())) {
                editPhoneInput.classList.add("is-valid");
                editPhoneInput.classList.remove("is-invalid");
                return true;
            } else {
                editPhoneInput.classList.add("is-invalid");
                editPhoneInput.classList.remove("is-valid");
                return false;
            }
        }

        form.addEventListener("submit", function (e) {
            e.preventDefault();
            if (validateUsername() & validateMobile() & validatePassword()) {
                updateStudentProfile();
            }
        });

        function updateStudentProfile() {
            const student = {
                name: editNameInput.value.trim(),
                phone: editPhoneInput.value.trim(),
                password: editPassInput.value.trim(),
                usertype: "student"
            };
            fetch(`${apiUrl}/users/${getUserId()}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(student)
            }).then(() => {
                loadStudentProfile();
                clearValidation();
            });
        }

        function clearValidation() {
            editNameInput.classList.remove("is-invalid");
            editPhoneInput.classList.remove("is-invalid");
            editPassInput.classList.remove("is-invalid");
        }

        loadStudentProfile();
    })();
</script>