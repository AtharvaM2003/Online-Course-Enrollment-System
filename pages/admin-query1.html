<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="#" onclick="loadPage('admin-admin-query1.html')">Queries</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">Courses by Students</li>
    </ol>
</nav>

<div class="container mt-4">
    <div class="form-group">
        <label for="studentDropdown">Select Student:</label>
        <select class="form-control" id="studentDropdown" onchange="fetchEnrollments()">
            <option value="">-- Select Student --</option>
        </select>
    </div>

    <h4 class="mt-4">Courses Enrolled:</h4>
    <ul id="courseList" class="list-group"></ul>
</div>

<script>
    (() => {
        let users = [];
        let enrollments = [];
        let courses = [];

        async function fetchData() {
            try {
                const usersRes = await fetch('http://localhost:3000/Users');
                users = await usersRes.json();

                const enrollmentsRes = await fetch('http://localhost:3000/Enrollments');
                enrollments = await enrollmentsRes.json();

                const coursesRes = await fetch('http://localhost:3000/Courses');
                courses = await coursesRes.json();

                populateDropdown();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function populateDropdown() {
            const dropdown = document.getElementById('studentDropdown');
            users.forEach(user => {
                if (user.usertype.toLowerCase() === 'student') {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    dropdown.appendChild(option);
                }
            });

            // âœ… Attach the event listener AFTER populating
            dropdown.addEventListener('change', fetchEnrollments);
        }

        function fetchEnrollments() {
            const selectedUserId = document.getElementById('studentDropdown').value;
            const courseList = document.getElementById('courseList');
            courseList.innerHTML = '';

            if (selectedUserId) {
                const enrolledCourses = enrollments.filter(enrollment => enrollment.userid == selectedUserId);

                if (enrolledCourses.length > 0) {
                    enrolledCourses.forEach(enrollment => {
                        const course = courses.find(c => c.id == enrollment.courseid);
                        if (course) {
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            li.textContent = `${course.title} - ${course.description}`;
                            courseList.appendChild(li);
                        }
                    });
                } else {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = 'No courses enrolled.';
                    courseList.appendChild(li);
                }
            }
        }

        fetchData();
    })();

</script>