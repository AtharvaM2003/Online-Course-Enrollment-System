<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="#" onclick="loadPage('admin-query2.html')">Queries</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">Students by Course</li>
    </ol>
</nav>

<div class="container mt-4">
    <div class="form-group">
        <label for="courseDropdown">Select Course:</label>
        <select class="form-control" id="courseDropdown">
            <option value="">-- Select Course --</option>
        </select>
    </div>

    <h4 class="mt-4">Students Enrolled:</h4>
    <ul id="studentList" class="list-group"></ul>
</div>

<script>
    (() => {
        let allUsers = [];
        let allEnrollments = [];
        let allCourses = [];
        const userUrl = 'http://localhost:3000/Users';
        const EnrollmentsUrl = 'http://localhost:3000/Enrollments';
        const CoursesUrl = 'http://localhost:3000/Courses';

        //Fetch User, Enrollments, Courses------------------------------------------
        function fetchData() {
            Promise.all([
                fetch(userUrl).then(res => res.json()),
                fetch(EnrollmentsUrl).then(res => res.json()),
                fetch(CoursesUrl).then(res => res.json())
            ])
                .then(([usersData, enrollmentsData, coursesData]) => {
                    allUsers = usersData;
                    allEnrollments = enrollmentsData;
                    allCourses = coursesData;
                    renderCourseDropdown();
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }


        //Display User, Enrollments, Courses in Select------------------------------------------
        function renderCourseDropdown() {
            const dropdown = document.getElementById('courseDropdown');
            allCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.title;
                dropdown.appendChild(option);
            });

            dropdown.addEventListener('change', fetchStudents);
        }


        //Display Student of Enrolled Courses----------------------------------------
        function fetchStudents() {
            const selectedCourseId = document.getElementById('courseDropdown').value;
            const studentList = document.getElementById('studentList');
            studentList.innerHTML = '';

            if (selectedCourseId) {
                const enrolledStudents = allEnrollments.filter(enrollment => enrollment.courseid == selectedCourseId);

                if (enrolledStudents.length > 0) {
                    enrolledStudents.forEach(enrollment => {
                        const user = allUsers.find(u => u.id == enrollment.userid);
                        if (user) {
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            li.textContent = `${user.name} - ${user.email} - ${user.phone}`;
                            studentList.appendChild(li);
                        }
                    });
                } else {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = 'No students enrolled.';
                    studentList.appendChild(li);
                }
            }
        }

        fetchData();
    })();
    //END--------------------------------------------------------------------------

</script>